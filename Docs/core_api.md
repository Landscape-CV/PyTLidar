
# PyTLiDAR TreeQSM API Documentation

This document provides API documentation for the core functions in the core TreeQSM functionality, in order of execution.

---
## Utils

### Utils.load_point_cloud

Loads a point cloud from LAS or LAZ files and converts it to numpy format

**Args:**
- `file_path` (`str`): Path to the LAS or LAZ file.
- `intensity_threshold` (`int`, optional): Threshold for filtering points based on intensity. Default is 0.
- `full_data` (`bool`, optional): If `True`, returns both the point cloud and additional point data. Default is `False`.

**Returns:**
- `point_cloud` (`ndarray`): Nx3 matrix of point coordinates (x, y, z).
- `(point_cloud, point_data)` (`tuple`, optional): If `full_data` is `True`, returns a tuple containing the point cloud and additional point data.

---

## define_input.py

### define_input

Estimates required parameters for TreeQSM reconstruction from tree point clouds. 
If a list of point clouds is provided, define_input will calculate values for all trees and each will have a separate dictionary of parameters.
The singular parameter dictionary should be input into the later functions. 

**Args:**
- `clouds` (`ndarray`, `str`, or `list of str`): Point cloud of a tree (Nx3 array), or the filename(s) of LAS/LAZ files.
- `nPD1` (`int`, optional): Number of parameter values for `PatchDiam1`. Default is 1.
- `nPD2Min` (`int`, optional): Number of parameter values for `PatchDiam2Min`. Default is 1.
- `nPD2Max` (`int`, optional): Number of parameter values for `PatchDiam2Max`. Default is 1.

**Returns:**
- `list of dict`: List of input structures with the estimated parameter values for each tree.

---


## cover_sets.py

### cover_sets

Creates Voronoi partition (cover sets) and their neighbor-relation for a point cloud.

During the first pass, no RelSize should be provided. This will create the partition using cover sets of uniform size based on PatchDiam1.
During the second pass, RelSize (the output from the relative_size function) will create cover sets ranging from PatchDiam2Min to PatchDiam2Max based on the relative size of the segments found in the first pass.

**Args:**
- `P` (`numpy.ndarray`): Point cloud.
- `inputs`: Input structure, the following fields are needed:
  - `PatchDiam1`: Minimum distance between centers of cover sets; i.e. the minimum diameter of cover set in uniform covers.
  - `PatchDiam2Min`: Minimum diameter of cover sets for variable-size covers. Needed if "RelSize" is given as input.
  - `PatchDiam2Max`: Maximum diameter of cover sets for variable-size covers. Needed if "RelSize" is given as input.
  - `BallRad1`: Radius of the balls used to generate the uniform cover. These balls are also used to determine the neighbors.
  - `BallRad2`: Maximum radius of the balls used to generate the variable-size cover.
  - `nmin1`, `nmin2`: Minimum number of points in a BallRad1- and BallRad2-ball.
- `RelSize`: Relative cover set size for each point (output from relative_size function)

**Returns:**
- `dict`: Dictionary containing:
  - `ball`: Cover sets, (n_sets x 1)-cell.
  - `center`: Center points of the cover sets, (n_sets x 1)-vector.
  - `neighbor`: Neighboring cover sets of each cover set, (n_sets x 1)-cell.

---

## tree_sets.py

### tree_sets

Defines the location of the base of the trunk on the first pass with no value provided for segments and updates neighbor relationships based on trunk definition
On the second pass, defines the main branches based on the provided segment dictionary and updates neighbor relationships based on findings


**Args:**
- `P` (`np.ndarray`): Point cloud.
- `cover` (`dict`): Cover sets, their centers and neighbors.
- `inputs` (`dict`): Input parameters.
- `segment` (`dict`, optional): Previous segments-- Output of segments function.

**Returns:**
- `(dict, np.ndarray, np.ndarray)`: Cover sets with updated neighbors, base of the trunk, cover sets not part of the tree.

---

## segments.py

### segments

Divides the provided cover sets into segments based on topological structure. 
Starting with the base, segments are created when the function determines there are multiple branching structures of sufficient size. 
If qsm is false, any diverging section is considered a new segment and will not consider any portion a continuation of the parent segment.

**Args:**
- `cover` (`dict`): Cover sets generated by the cover function.
- `Base` (`np.ndarray`): Base of the tree generated by the tree sets function.
- `Forb` (`np.ndarray`): Cover sets not part of the tree generated by the tree sets function.
- `qsm` (`bool`): If False, any branching components will be considered a new segment, and parent segment will not continue. Defaults to True. Only set to false if not continuing with cylinder definition

**Returns:**
- `dict`: Dictionary containing:
  - `segments`: Segments found, list of lists, each list contains the cover sets.
  - `ParentSegment`: Parent segment of each segment, list of integers.
  - `ChildSegment`: Children segments of each segment, list of lists.

---
## correct_segments.py

### correct_segments

Reassigns segments to make them more consistent with expected tree structure.
This includes removing small branches, extending branch segments, and modifying the base.
This may be considered optional when working with trees with non-standard structure where assumptions may not hold true.

**Args:**
- `P` (`np.ndarray`): Point Cloud.
- `cover` (`dict`): Cover set information generated by cover function.
- `segment` (`dict`): Segment information generated by segment function.
- `inputs` (`dict`): Run input information.
- `RemSmall` (`bool`, optional): If True, removes small segments (second pass). Defaults to False.
- `ModBases` (`bool`, optional): If True, modifies the bases of segments (both passes). Defaults to True.
- `AddChild` (`bool`, optional): If True, adds the expanded base to the child segment and removes it from the parent (first pass). Defaults to True.

**Returns:**
- `dict`: Modified segment information.

---

## relative_size.py

### relative_size

Determines the relative size of cover sets distributed over new covers. The relative size decreases as the branch size decreases, with the maximum size at the base of the stem and the minimum size at the tip of every branch. This is achieved by using the branching structure and segmentation of the tree to adjust the relative size based on the branch's position and size.

**Args:**
- `P` (`numpy.ndarray`): Point cloud (Nx3 array).
- `cover` (`dict`): Structure array containing the following fields:
  - `ball` (`list` of `numpy.ndarray`): Cover sets, where each element is an array of point indices in the cover set.
  - `center` (`numpy.ndarray`): Center points of the cover sets (indices of points in `P`).
  - `neighbor` (`list` of `numpy.ndarray`): Neighboring cover sets for each cover set.
- `segment` (`dict`): Dictionary containing the following fields:
  - `segments` (`list` of `list` of `numpy.ndarray`): Segments found, where each segment is a list of cover sets.
  - `ParentSegment` (`list` of `int`): Parent segment of each segment (0 if no parent segment).
  - `ChildSegment` (`list` of `list` of `int`): Children segments of each segment.

**Returns:**
- `numpy.ndarray`: Relative size values (1-256) for each point in the point cloud, as a `uint8` vector.

---



## cylinders.py

### cylinders

Fits cylinders to the branch-segments of the point cloud. 
Reconstructs the surface and volume of branches of input tree with cylinders. 
Subdivides each segment to smaller regions to which cylinders are fitted in least squares sense. Returns the cylinder information and in addition the child-relation of the cylinders plus the cylinders in each segment.

**Args:**
- `P` (`np.ndarray`): Point cloud, matrix.
- `cover` (`dict`): Cover sets generated by the cover function.
- `segment` (`dict`): Segments generated by the segment function.
- `inputs` (`dict`): Relevant Input parameters of the reconstruction:
  - `MinCylRad`: Minimum cylinder radius, used in the taper corrections.
  - `ParentCor`: Radius correction based on radius of the parent.
  - `TaperCor`: Parabola taper correction of radii inside branches.
  - `GrowthVolCor`: If 1, use growth volume correction.
  - `GrowthVolFac`: Growth volume correction factor.

**Returns:**
- `dict`: Structure array containing the following cylinder info:
  - `radius`: Radii of the cylinders, vector.
  - `length`: Lengths of the cylinders, vector.
  - `axis`: Axes of the cylinders, matrix.
  - `start`: Starting points of the cylinders, matrix.
  - `parent`: Parents of the cylinders, vector.
  - `extension`: Extensions of the cylinders, vector.
  - `branch`: Branch of the cylinder.
  - `BranchOrder`: Branching order of the cylinder.
  - `PositionInBranch`: Position of the cylinder inside the branch.
  - `mad`: Mean absolute distances of points from the cylinder surface, vector.
  - `SurfCov`: Surface coverage measure, vector.
  - `added`: Added cylinders, logical vector.
  - `UnModRadius`: Unmodified radii.

---
## branches.py

### branches

Identifies the branching structure of a tree based on cylinder data generated during the TreeQSM process. It computes various attributes for each branch, such as order, parent-child relationships, volume, length, angle, height, azimuth, and diameter. The trunk is considered branch number one, with an order of zero.

**Args:**
- `cylinder` (`dict`): Dictionary containing cylinder data generated by the cylinders function
 

**Returns:**
- `dict`: Dictionary containing branch attributes with the following keys:
  - `order` (`numpy.ndarray`): Branch order (uint8).
  - `parent` (`numpy.ndarray`): Parent branch number for each branch.
  - `diameter` (`numpy.ndarray`): Diameter of each branch (in meters).
  - `volume` (`numpy.ndarray`): Volume of each branch (in liters).
  - `area` (`numpy.ndarray`): Surface area of each branch (in square meters).
  - `length` (`numpy.ndarray`): Length of each branch (in meters).
  - `angle` (`numpy.ndarray`): Angle of each branch relative to its parent (in degrees).
  - `height` (`numpy.ndarray`): Height of each branch (in meters).
  - `azimuth` (`numpy.ndarray`): Azimuth angle of each branch (in degrees).
  - `zenith` (`numpy.ndarray`): Zenith angle of each branch (in degrees).
  - `x` (`numpy.ndarray`): X-coordinate of the starting point of each branch.
  - `y` (`numpy.ndarray`): Y-coordinate of the starting point of each branch.
  - `z` (`numpy.ndarray`): Z-coordinate of the starting point of each branch.

---

## tree_data.py

### tree_data

Calculates tree attributes from cylinder QSM data.
Creates a dictionary with DBH, height, volume, surface area, branch calculations (count, volume,length, diameter, height, angle), and measurements of the crown hull.

**Args:**
- `cylinder` (`dict`): Cylinder data (radius, length, start, axis, branch).
- `branch` (`dict`): Branch data (order, volume, length, diameter, height, angle, zenith, azimuth).
- `trunk` (`np.ndarray`): Point cloud of the trunk.
- `inputs` (`dict`): Input structure defining if results are displayed, plotted, and if triangulation is computed.

**Returns:**
- `(dict, int/dict)`: Tree data and triangulation results (triangulation results are 0 if not computed -- triangulation results are not available in this release and this will always return 0).
- Tree Data dictionary returns in the form:
  - `DBH` (float): Diameter at breast height.
  - `Height` (float): Total height of the tree.
  - `Volume` (float): Total volume of the tree.
  - `SurfaceArea` (float): Total surface area of the tree.
  - `BranchCount` (int): Total number of branches.
  - `BranchVolume` (numpy.ndarray): Volume of each branch.
  - `BranchLength` (numpy.ndarray): Length of each branch.
  - `BranchDiameter` (numpy.ndarray): Diameter of each branch.
  - `BranchHeight` (numpy.ndarray): Height of each branch.
  - `BranchAngles` (numpy.ndarray): Angles of each branch.
  - `CrownMetrics` (dict): Dictionary containing crown-related metrics.
  
  

---





