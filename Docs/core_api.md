
# PyTLiDAR TreeQSMSteps API Documentation

This document provides API documentation for the main functions in the `TreeQSMSteps` module, based on their docstrings. Only functions with docstrings are included.

---

## cover_sets.py

### cover_sets

Creates cover sets (surface patches) and their neighbor-relation for a point cloud.

**Args:**
- `P` (`numpy.ndarray`): Point cloud.
- `inputs`: Input structure, the following fields are needed:
  - `PatchDiam1`: Minimum distance between centers of cover sets; i.e. the minimum diameter of cover set in uniform covers.
  - `PatchDiam2Min`: Minimum diameter of cover sets for variable-size covers. Needed if "RelSize" is given as input.
  - `PatchDiam2Max`: Maximum diameter of cover sets for variable-size covers. Needed if "RelSize" is given as input.
  - `BallRad1`: Radius of the balls used to generate the uniform cover. These balls are also used to determine the neighbors.
  - `BallRad2`: Maximum radius of the balls used to generate the variable-size cover.
  - `nmin1`, `nmin2`: Minimum number of points in a BallRad1- and BallRad2-ball.
- `RelSize`: Relative cover set size for each point.

**Returns:**
- `dict`: Dictionary containing:
  - `ball`: Cover sets, (n_sets x 1)-cell.
  - `center`: Center points of the cover sets, (n_sets x 1)-vector.
  - `neighbor`: Neighboring cover sets of each cover set, (n_sets x 1)-cell.

---

### uniform_cover

Creates uniform cover sets and neighbor-relation of a point cloud using fixed-radius balls.

**Args:**
- `P` (`numpy.ndarray`): Point cloud.
- `inputs`: Input structure, the following fields are needed:
  - `PatchDiam1`: Minimum distance between centers of cover sets.
  - `BallRad1`: Radius of the balls used to generate the uniform cover.
  - `nmin1`: Minimum number of points in a BallRad1 ball.
- `np_points` (`int`): The total number of points in the point cloud.

**Returns:**
- `dict`: Dictionary containing:
  - `ball`: Cover sets, (n_sets x 1)-cell.
  - `center`: Center points of the cover sets, (n_sets x 1)-vector.

---

### variable_cover

Creates variable-size cover sets and neighbor-relation for a point cloud.

**Args:**
- `P` (`numpy.ndarray`): Point cloud.
- `inputs`: Input structure.
- `RelSize`: Relative size for each point.
- `np_points` (`int`): Number of points.

**Returns:**
- `dict`: Dictionary containing:
  - `ball`: Cover sets.
  - `center`: Center points.
  - `neighbor`: Neighboring cover sets.

---

### create_PointsInSets

Generates array of points in each cover set. Separated out for numba compilation.

**Args:**
- `nb` (`int`): Number of cover sets.
- `np_points` (`int`): Number of points.
- `BoP` (`np.ndarray`): Ball/cover set assignment for each point.

**Returns:**
- `list`: List of arrays, each containing the indices of points in a cover set.

---

### create_cover

Creates the cover sets data structure.

**Args:**
- `Ball` (`list`): Large balls for generation of the cover sets and their neighbors.
- `Cen` (`list`): Center points of the balls/cover sets.
- `BoP` (`np.ndarray`): Ball/cover set assignment for each point.
- `nb` (`int`): Number of sets generated.
- `np_points` (`int`): Number of points.

**Returns:**
- `dict`: Dictionary containing:
  - `ball`: Cover sets.
  - `center`: Center points.
  - `neighbor`: Neighboring cover sets.
  - `sets`: Ball/cover set assignment for each point (zero-based).

---

## correct_segments.py

### correct_segments

Reassigns segments to make them more consistent with expected tree structure.

**Args:**
- `P` (`np.ndarray`): Point Cloud.
- `cover` (`dict`): Cover set information generated by cover function.
- `segment` (`dict`): Segment information generated by segment function.
- `inputs` (`dict`): Run input information.
- `RemSmall` (`bool`, optional): If True, removes small segments (second pass). Defaults to None.
- `ModBases` (`bool`, optional): If True, modifies the bases of segments (second pass). Defaults to None.
- `AddChild` (`bool`, optional): If True, adds the expanded base to the child segment and removes it from the parent (second pass). Defaults to None.

**Returns:**
- `dict`: Modified segment information.

---

### search_stem_top

Search the stem's top segment such that the resulting stem:
1. Is one of the highest segments (goes to the top of the tree),
2. Is horizontally close to the bottom of the stem (goes straight up),
3. Has a length close to the distance between its bottom and top (is not too curved).

**Args:**
- `P` (`np.ndarray`): Point cloud.
- `Ce` (`np.ndarray`): Centers of the cover sets.
- `Bal` (`list`): Ball (cover set) indices.
- `Segs` (`list`): Segments.
- `SPar` (`np.ndarray`): Parent segment information.
- `dmin` (`float`): Minimum distance parameter.

**Returns:**
- `int`: Index of the stem's top segment.

---

### modify_topology

Make stem and branches as long as possible by modifying the topology.

**Args:**
- `P` (`np.ndarray`): Point cloud.
- `Ce` (`np.ndarray`): Centers of the cover sets.
- `Bal` (`list`): Ball (cover set) indices.
- `Segs` (`list`): Segments.
- `SPar` (`np.ndarray`): Parent segment information.
- `SChi` (`list`): Child segment information.
- `dmin` (`float`): Minimum distance parameter.

**Returns:**
- `(list, np.ndarray, list)`: Modified segments, modified parent segment information, and modified child segment information.

---

## cylinders.py

### cylinders

Fits cylinders to the branch-segments of the point cloud. Reconstructs the surface and volume of branches of input tree with cylinders. Subdivides each segment to smaller regions to which cylinders are fitted in least squares sense. Returns the cylinder information and in addition the child-relation of the cylinders plus the cylinders in each segment.

**Args:**
- `P` (`np.ndarray`): Point cloud, matrix.
- `cover` (`dict`): Cover sets generated by the cover function.
- `segment` (`dict`): Segments generated by the segment function.
- `inputs` (`dict`): Relevant Input parameters of the reconstruction:
  - `MinCylRad`: Minimum cylinder radius, used in the taper corrections.
  - `ParentCor`: Radius correction based on radius of the parent.
  - `TaperCor`: Parabola taper correction of radii inside branches.
  - `GrowthVolCor`: If 1, use growth volume correction.
  - `GrowthVolFac`: Growth volume correction factor.

**Returns:**
- `dict`: Structure array containing the following cylinder info:
  - `radius`: Radii of the cylinders, vector.
  - `length`: Lengths of the cylinders, vector.
  - `axis`: Axes of the cylinders, matrix.
  - `start`: Starting points of the cylinders, matrix.
  - `parent`: Parents of the cylinders, vector.
  - `extension`: Extensions of the cylinders, vector.
  - `branch`: Branch of the cylinder.
  - `BranchOrder`: Branching order of the cylinder.
  - `PositionInBranch`: Position of the cylinder inside the branch.
  - `mad`: Mean absolute distances of points from the cylinder surface, vector.
  - `SurfCov`: Surface coverage measure, vector.
  - `added`: Added cylinders, logical vector.
  - `UnModRadius`: Unmodified radii.

---

## tree_data.py

### tree_data

Calculate tree attributes from cylinder QSM data.

**Args:**
- `cylinder` (`dict`): Cylinder data (radius, length, start, axis, branch).
- `branch` (`dict`): Branch data (order, volume, length, diameter, height, angle, zenith, azimuth).
- `trunk` (`np.ndarray`): Point cloud of the trunk.
- `inputs` (`dict`): Input structure defining if results are displayed, plotted, and if triangulation is computed.

**Returns:**
- `(dict, int/dict)`: Tree data and triangulation results (triangulation results are 0 if not computed).

---

### dbh_cylinder

Calculate the diameter at breast height (DBH) from cylinder data.

**Args:**
- `treedata` (`dict`): Dictionary to store tree data.
- `trunk` (`np.ndarray`): Point cloud of the trunk.
- `Trunk` (`np.ndarray`): Boolean array indicating trunk cylinders.
- `cylinder` (`dict`): Cylinder data (radius, length, start, axis).
- `ind` (`np.ndarray`): Indices of the cylinders.

**Returns:**
- `dict`: Updated tree data with DBH attributes.

---

### crown_measures

Calculate crown measures from cylinder and branch data.

**Args:**
- `treedata` (`dict`): Dictionary to store tree data.
- `cylinder` (`dict`): Cylinder data.
- `branch` (`dict`): Branch data.

**Returns:**
- `(dict, np.ndarray)`: Updated tree data and spreads.

---

### triangulate_stem

Calculate stem using triangulation method.

**Args:**
- `treedata` (`dict`): Dictionary to store tree data.
- `cylinder` (`dict`): Cylinder data (start, radius, length, axis, branch).
- `branch` (`dict`): Branch data (diameter, height, order).
- `trunk` (`np.ndarray`): Point cloud of the trunk.

**Returns:**
- `(dict, dict)`: Updated tree data with triangulation attributes and triangulation data.

---

## segments.py

### segments

Segments the covered point cloud into branches.

**Args:**
- `cover` (`dict`): Cover sets generated by the cover function.
- `Base` (`np.ndarray`): Base of the tree generated by the tree sets function.
- `Forb` (`np.ndarray`): Cover sets not part of the tree generated by the tree sets function.
- `qsm` (`bool`): If True, any branching components will be considered a new segment, and parent segment will not continue.

**Returns:**
- `dict`: Dictionary containing:
  - `segments`: Segments found, list of lists, each list contains the cover sets.
  - `ParentSegment`: Parent segment of each segment, list of integers.
  - `ChildSegment`: Children segments of each segment, list of lists.

---

## tree_sets.py

### tree_sets

Defines the location of the base of the trunk on the first pass, and the main branches on the second.

**Args:**
- `P` (`np.ndarray`): Point cloud.
- `cover` (`dict`): Cover sets, their centers and neighbors.
- `inputs` (`dict`): Input parameters.
- `segment` (`dict`, optional): Previous segments.

**Returns:**
- `(dict, np.ndarray, np.ndarray)`: Cover sets with updated neighbors, base of the trunk, cover sets not part of the tree.

---

### define_trunk

Determines the trunk of the tree by expanding the base upwards through connected cover sets. Used by `tree_sets` function only, not a standalone function.

**Args:**
- `cover` (`dict`): Cover sets.
- `aux` (`dict`): Auxiliary data.
- `Base` (`np.ndarray`): Base indices.
- `Forb` (`np.ndarray`): Forbidden indices.
- `inputs` (`dict`): Input parameters.

**Returns:**
- `tuple`: Trunk mask and updated cover.

---

### define_main_branches

Determines location of the primary branches of tree. Used by `tree_sets` function only, not a standalone function.

**Args:**
- `cover` (`dict`): Cover sets.
- `segment` (`dict`): Segment data.
- `aux` (`dict`): Auxiliary data.
- `inputs` (`dict`): Input parameters.

**Returns:**
- `tuple`: Trunk mask and updated cover.

---
